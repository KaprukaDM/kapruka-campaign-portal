<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kapruka Admin Portal</title>
  <link rel="icon" type="image/png" href="https://www.kapruka.com/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #5e3a8e;
      --primary-dark: #422b73;
      --accent: #FFD700;
      --bg-gradient: linear-gradient(135deg, #1a0b2e 0%, #3d2461 50%, #5e3a8e 100%);
      --glass: rgba(255, 255, 255, 0.96);
      --shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      padding: 40px 20px;
      color: #333;
    }

    /* --- LAYOUT --- */
    .container { max-width: 1600px; margin: 0 auto; }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }
    
    .kapruka-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--accent);
      margin-bottom: 15px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    h1 { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
    .subtitle { opacity: 0.8; font-size: 14px; letter-spacing: 1px; text-transform: uppercase; }

    /* --- TABS --- */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .tab-btn {
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .tab-btn:hover, .tab-btn.active {
      background: var(--accent);
      color: var(--primary-dark);
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- CARDS & FORMS --- */
    .card {
      background: var(--glass);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    h2 { color: var(--primary); margin-bottom: 20px; font-size: 24px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group label { display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus { outline: none; border-color: var(--primary); }

    /* --- BUTTONS --- */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: #2e7d32; color: white; }
    .btn-warning { background: #f57c00; color: white; }
    .btn-danger { background: #c62828; color: white; }
    
    /* --- TABLES --- */
    .table-responsive { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th { background: #f8f9fa; padding: 15px; text-align: left; color: var(--primary); font-weight: 700; border-bottom: 2px solid #eee; }
    td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
    tr:hover { background: #fcfcfc; }

    /* --- BADGES --- */
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .badge-approved { background: #e8f5e9; color: #2e7d32; }
    .badge-pending { background: #fff3e0; color: #ef6c00; }
    .badge-rejected { background: #ffebee; color: #c62828; }
    .badge-empty { background: #f5f5f5; color: #999; border: 1px dashed #ccc; }

    /* --- STUDIO VERTICAL CALENDAR --- */
    .studio-day-container {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin-bottom: 30px;
      overflow: hidden;
      background: white;
    }

    .studio-day-header {
      background: var(--primary);
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .studio-day-title { font-size: 18px; font-weight: 700; }
    .studio-day-meta { font-size: 13px; opacity: 0.9; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 4px; }

    .studio-slots-container {
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .slot-card {
      border-radius: 10px;
      padding: 15px;
      position: relative;
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 140px;
    }

    .slot-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

    /* Slot Types */
    .slot-lead { border: 2px solid #e3f2fd; background: #fbfdff; }
    .slot-content { border: 2px solid #f3e5f5; background: #fdfbff; }
    .slot-empty { border: 2px dashed #e0e0e0; background: #fafafa; opacity: 0.8; cursor: default; }

    /* Status Indicators */
    .slot-status {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .status-received { background: #e0e0e0; color: #555; }
    .status-working { background: #fff8e1; color: #f57f17; }
    .status-submitted { background: #e1bee7; color: #7b1fa2; }
    .status-approved { background: #e8f5e9; color: #2e7d32; }

    .slot-number { font-size: 12px; font-weight: 700; color: #999; margin-bottom: 5px; text-transform: uppercase; }
    .slot-title { font-weight: 600; color: #333; margin-bottom: 5px; line-height: 1.3; }
    .slot-details { font-size: 12px; color: #666; }

    /* --- MODALS --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      width: 90%;
      max-width: 600px;
      border-radius: 16px;
      padding: 30px;
      position: relative;
      animation: zoomIn 0.2s;
    }

    @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .slot-picker-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .picker-slot {
      padding: 15px;
      border: 2px solid #eee;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 13px;
    }

    .picker-slot:hover { border-color: var(--primary); background: #f3e5f5; }
    .picker-slot.booked { background: #eee; color: #999; cursor: not-allowed; border-color: #eee; }
    .picker-slot.selected { background: var(--primary); color: white; border-color: var(--primary); }

    /* --- LOGIN --- */
    .login-wrapper {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-gradient);
      display: flex; align-items: center; justify-content: center;
      z-index: 2000;
    }
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<div id="loginScreen" class="login-wrapper">
  <div class="login-box">
    <img src="https://www.kapruka.com/favicon.ico" class="kapruka-logo" style="width:60px;height:60px;border:none;box-shadow:none;">
    <h2 style="border:none;margin-bottom:10px;">Admin Access</h2>
    <p style="color:#666;margin-bottom:20px;">Enter credentials to continue</p>
    <form id="loginForm">
      <input type="password" id="adminPassword" placeholder="Enter Password" style="margin-bottom:15px;">
      <button type="submit" class="btn btn-primary" style="width:100%;">Unlock Dashboard</button>
    </form>
  </div>
</div>

<div class="container" id="mainContent" style="display:none;">
  
  <div class="header">
    <img src="https://www.kapruka.com/favicon.ico" class="kapruka-logo">
    <h1>Campaign Portal Admin</h1>
    <div class="subtitle">Kapruka Global Shop & E-commerce Operations</div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('requests')">Campaign Requests</button>
    <button class="tab-btn" onclick="switchTab('products')">Product Suggestions</button>
    <button class="tab-btn" onclick="switchTab('content')">Content Calendar</button>
    <button class="tab-btn" onclick="switchTab('studio')">Studio Calendar</button>
    <button class="tab-btn" onclick="switchTab('hot')">Hot Products</button>
    <button class="tab-btn btn-danger" onclick="location.reload()">Logout</button>
  </div>

  <div id="tab-requests" class="tab-content active">
    <div class="card">
      <h2>üì¢ Campaign Requests</h2>
      <div class="table-responsive">
        <table id="requestsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Department</th>
              <th>Campaign</th>
              <th>Slot</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-products" class="tab-content">
    <div class="card">
      <h2>üí° Product Suggestions</h2>
      <div class="table-responsive">
        <table id="productsTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Margin</th>
              <th>Status</th>
              <th>Assigned Page</th>
              <th>Scheduled For</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-content" class="tab-content">
    <div class="card">
      <h2>üìÖ Content Calendar Items</h2>
      <div style="margin-bottom:20px;text-align:right;">
         <button class="btn btn-primary" onclick="promptAddTheme()">+ Add New Theme</button>
      </div>
      <div class="table-responsive">
        <table id="contentTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Theme</th>
              <th>Category</th>
              <th>Product Code</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-studio" class="tab-content">
    <div class="card" style="background:transparent;box-shadow:none;padding:0;">
      <div style="display:flex;justify-content:center;gap:20px;margin-bottom:30px;">
        <button class="btn btn-primary" onclick="changeStudioMonth(-1)">‚óÄ Previous Week</button>
        <h2 id="studioDateRange" style="border:none;margin:0;color:white;text-shadow:0 2px 4px rgba(0,0,0,0.5);">Jan 26 - Feb 01</h2>
        <button class="btn btn-primary" onclick="changeStudioMonth(1)">Next Week ‚ñ∂</button>
      </div>
      
      <div id="studioVerticalContainer">
        </div>
    </div>
  </div>

  <div id="tab-hot" class="tab-content">
    <div class="card">
      <h2>üî• Hot Products</h2>
      <form id="addHotForm" style="margin-bottom:30px;background:#f9f9f9;padding:20px;border-radius:12px;">
        <div class="form-grid">
          <div class="form-group">
            <label>Category</label>
            <select id="hotCategory">
              <option>Cakes</option><option>Flowers</option><option>Chocolates</option>
              <option>Fashion</option><option>Electronics</option><option>Toys</option>
            </select>
          </div>
          <div class="form-group">
            <label>Product Link</label>
            <input type="url" id="hotLink" placeholder="https://..." required>
          </div>
          <div class="form-group">
            <label>Sales Count</label>
            <input type="number" id="hotSales" value="0">
          </div>
        </div>
        <button type="submit" class="btn btn-success">Add Hot Product</button>
      </form>

      <div class="table-responsive">
        <table id="hotTable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Product Link</th>
              <th>Sales</th>
              <th>Listed?</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<div id="approveModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeModal('approveModal')">&times;</span>
    <h2>‚úÖ Approve & Schedule</h2>
    <p>Select the page and slot for this product.</p>
    
    <div class="form-group">
      <label>1. Assign to Page</label>
      <select id="approvePageSelect" onchange="fetchSlotsForPage(this.value)">
        <option value="">Select Page...</option>
        <option value="Kapruka FB Leads">Kapruka FB Leads (Mon)</option>
        <option value="Social Mart">Social Mart (Tue)</option>
        <option value="Electronic Factory">Electronic Factory (Wed)</option>
        <option value="Fashion Factory">Fashion Factory (Thu)</option>
        <option value="Toys Factory">Toys Factory (Fri)</option>
        <option value="Handbag Factory">Handbag Factory (Sat)</option>
      </select>
    </div>

    <div id="slotPickerArea" style="display:none;">
      <label style="font-weight:600;display:block;margin-top:15px;">2. Select Available Slot</label>
      <div id="slotGrid" class="slot-picker-grid">
        </div>
    </div>

    <div style="margin-top:20px;text-align:right;">
      <button class="btn btn-success" id="confirmApproveBtn" disabled onclick="confirmProductApproval()">Confirm Schedule</button>
    </div>
  </div>
</div>

<div id="studioModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeModal('studioModal')">&times;</span>
    <h2 id="studioModalTitle">Manage Content</h2>
    <div id="studioModalDetails" style="margin-bottom:20px;background:#f5f5f5;padding:15px;border-radius:8px;font-size:14px;"></div>

    <div class="form-group">
      <label>Update Status</label>
      <select id="studioStatusSelect" onchange="handleStatusChange()">
        <option value="Received">Received</option>
        <option value="Working">Working</option>
        <option value="Submitted for Review">Submitted for Review</option>
        <option value="Approved">Approved (Head Only)</option>
      </select>
    </div>

    <div id="linkInputArea" style="display:none;margin-top:15px;">
      <div class="form-group">
        <label>Content Link (Required for Review)</label>
        <input type="url" id="studioContentLink" placeholder="https://drive.google.com/...">
      </div>
    </div>

    <div id="passwordArea" style="display:none;margin-top:15px;">
      <div class="form-group">
        <label>Head Password (Required for Approval)</label>
        <input type="password" id="headPassword" placeholder="Enter PIN">
      </div>
    </div>

    <div id="rejectionArea" style="display:none;margin-top:15px;">
        <div class="form-group">
            <label>Rejection Reason</label>
            <input type="text" id="rejectionReason" placeholder="Why is this rejected?">
        </div>
    </div>

    <div style="margin-top:20px;text-align:right;">
      <button class="btn btn-primary" onclick="saveStudioStatus()">Update Status</button>
    </div>
  </div>
</div>

<script src="js/supabase-api.js"></script>

<script>
  // --- STATE ---
  let selectedProductRow = null;
  let selectedSlotData = null;
  let selectedStudioId = null;
  let currentStudioDate = new Date(); // Tracks the start of the week for studio view

  // --- INITIALIZATION ---
  document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const pw = document.getElementById('adminPassword').value;
    if (pw === 'Kapruka2026!Admin') {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      loadAllTabs();
    } else {
      alert('Invalid Password');
    }
  });

  function loadAllTabs() {
    loadRequests();
    loadProducts();
    loadStudioCalendar(); // Initial load
    loadContent();
    loadHotProducts();
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    event.target.classList.add('active');
    
    if(tabId === 'studio') loadStudioCalendar();
    if(tabId === 'products') loadProducts();
  }

  // --- 1. CAMPAIGN REQUESTS ---
  async function loadRequests() {
    const data = await getAllRequests();
    const tbody = document.querySelector('#requestsTable tbody');
    tbody.innerHTML = data.map(r => `
      <tr>
        <td>${new Date(r.timestamp).toLocaleDateString()}</td>
        <td>${r.department}</td>
        <td>${r.campaign}</td>
        <td>${r.slot}</td>
        <td><span class="badge badge-pending">${r.status}</span></td>
        <td>
           <button class="btn btn-warning" style="padding:5px 10px;font-size:12px;" onclick="alert('Manage in Supabase')">Edit</button>
        </td>
      </tr>
    `).join('');
  }

  // --- 2. PRODUCT SUGGESTIONS & APPROVAL ---
  async function loadProducts() {
    const data = await getAllProductSuggestions();
    const tbody = document.querySelector('#productsTable tbody');
    tbody.innerHTML = data.map(p => {
      let actions = '';
      if(p.status === 'Pending') {
        actions = `<button class="btn btn-success" onclick="openApproveModal(${p.row})">Approve</button> 
                   <button class="btn btn-danger" onclick="rejectProduct(${p.row})">Reject</button>`;
      } else {
        actions = `<span style="font-size:12px;color:#666;">${p.status}</span>`;
      }

      return `<tr>
        <td><a href="${p.productLink}" target="_blank">View Product</a></td>
        <td>${p.category}</td>
        <td>${p.margin}%</td>
        <td><span class="badge badge-${p.status.toLowerCase()}">${p.status}</span></td>
        <td>${p.assignedPage || '-'}</td>
        <td>${p.slotDate ? p.slotDate + ' (Slot ' + p.slotNumber + ')' : '-'}</td>
        <td>${actions}</td>
      </tr>`;
    }).join('');
  }

  function openApproveModal(rowId) {
    selectedProductRow = rowId;
    selectedSlotData = null;
    document.getElementById('approvePageSelect').value = "";
    document.getElementById('slotPickerArea').style.display = 'none';
    document.getElementById('confirmApproveBtn').disabled = true;
    document.getElementById('approveModal').style.display = 'flex';
  }

  async function fetchSlotsForPage(pageName) {
    if(!pageName) return;
    document.getElementById('slotGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;">Loading slots...</div>';
    document.getElementById('slotPickerArea').style.display = 'block';

    try {
      const dates = await getAvailableSlotsForPage(pageName);
      const grid = document.getElementById('slotGrid');
      grid.innerHTML = '';

      dates.forEach(d => {
        d.slots.forEach(s => {
          const div = document.createElement('div');
          div.className = `picker-slot ${s.status === 'Booked' ? 'booked' : ''}`;
          div.innerHTML = `
            <strong>${d.date}</strong><br>
            Slot ${s.number}<br>
            <span style="font-size:10px;">${s.status}</span>
          `;
          
          if(s.status === 'Available') {
            div.onclick = () => selectSlot(div, d.date, s.number, pageName);
          }
          grid.appendChild(div);
        });
      });
    } catch (e) {
      console.error(e);
      alert('Error fetching slots');
    }
  }

  function selectSlot(el, date, number, page) {
    document.querySelectorAll('.picker-slot').forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
    selectedSlotData = { date, number, page };
    document.getElementById('confirmApproveBtn').disabled = false;
  }

  async function confirmProductApproval() {
    if(!selectedProductRow || !selectedSlotData) return;
    
    try {
      await updateProductReview(selectedProductRow, {
        status: 'Approved',
        reviewerName: 'Admin',
        assignedPage: selectedSlotData.page,
        slotDate: selectedSlotData.date,
        slotNumber: selectedSlotData.number
      });
      closeModal('approveModal');
      loadProducts();
      alert('Product Approved & Scheduled!');
    } catch (e) {
      alert(e.message);
    }
  }

  // --- 4. STUDIO VERTICAL CALENDAR ---
  async function loadStudioCalendar() {
    // Determine start/end of the current view (1 week view)
    const start = new Date(currentStudioDate);
    start.setDate(start.getDate() - start.getDay()); // Go to Sunday
    
    const end = new Date(start);
    end.setDate(end.getDate() + 6); // Go to Saturday

    const dateStrStart = start.toISOString().split('T')[0];
    const dateStrEnd = end.toISOString().split('T')[0];

    document.getElementById('studioDateRange').innerText = `${start.toDateString()} - ${end.toDateString()}`;

    const schedule = await getFullStudioSchedule(dateStrStart, dateStrEnd);
    const container = document.getElementById('studioVerticalContainer');
    container.innerHTML = '';

    schedule.forEach(day => {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'studio-day-container';
      
      let slotsHtml = '';
      
      // Fixed Slots (Lead Forms)
      day.leadSlots.forEach(slot => {
        if(slot.is_empty) {
          slotsHtml += `
            <div class="slot-card slot-empty">
              <div class="slot-number">Slot ${slot.slot_number} - ${slot.page_name}</div>
              <div class="slot-title" style="color:#999;">Empty Slot</div>
              <div class="slot-details">Waiting for product...</div>
            </div>`;
        } else {
           slotsHtml += renderBookedSlot(slot, 'slot-lead');
        }
      });

      // Content Calendar Slots
      day.contentSlots.forEach(slot => {
        slotsHtml += renderBookedSlot(slot, 'slot-content');
      });

      dayDiv.innerHTML = `
        <div class="studio-day-header">
          <span class="studio-day-title">${day.dayName}, ${day.date}</span>
          <span class="studio-day-meta">${day.leadSlots.length} Lead Slots | ${day.contentSlots.length} Content Items</span>
        </div>
        <div class="studio-slots-container">
          ${slotsHtml}
        </div>
      `;
      container.appendChild(dayDiv);
    });
  }

  function renderBookedSlot(slot, cssClass) {
    let statusClass = 'status-received';
    if(slot.studio_status === 'Working') statusClass = 'status-working';
    if(slot.studio_status === 'Submitted for Review') statusClass = 'status-submitted';
    if(slot.studio_status === 'Approved') statusClass = 'status-approved';

    return `
      <div class="slot-card ${cssClass}" onclick="openStudioModal(${slot.id})">
        <div class="slot-status ${statusClass}">${slot.studio_status}</div>
        <div class="slot-number">${slot.slot_type === 'lead_form' ? 'Lead Form Slot ' + slot.slot_number : 'Content Calendar'}</div>
        <div class="slot-title">${slot.content_details || 'Content Item'}</div>
        <div class="slot-details">
          Page: ${slot.page_name || 'N/A'}<br>
          Format: ${slot.format || 'N/A'}
        </div>
        ${slot.head_approved ? '<div style="margin-top:10px;font-size:11px;color:green;">‚úÖ Head Approved</div>' : ''}
      </div>`;
  }

  function changeStudioMonth(weeks) {
    currentStudioDate.setDate(currentStudioDate.getDate() + (weeks * 7));
    loadStudioCalendar();
  }

  // --- STUDIO MODAL WORKFLOW ---
  async function openStudioModal(id) {
    selectedStudioId = id;
    const item = await getStudioCalendarItem(id);
    if(!item) return;

    document.getElementById('studioModalTitle').innerText = item.content_details || 'Manage Content';
    document.getElementById('studioModalDetails').innerHTML = `
      <strong>Date:</strong> ${item.date}<br>
      <strong>Page:</strong> ${item.page_name}<br>
      <strong>Format:</strong> ${item.format}
      ${item.content_link ? `<br><strong>Link:</strong> <a href="${item.content_link}" target="_blank">View Content</a>` : ''}
    `;

    document.getElementById('studioStatusSelect').value = item.studio_status || 'Received';
    handleStatusChange(); // Show/hide fields
    
    document.getElementById('studioModal').style.display = 'flex';
  }

  function handleStatusChange() {
    const status = document.getElementById('studioStatusSelect').value;
    document.getElementById('linkInputArea').style.display = (status === 'Submitted for Review') ? 'block' : 'none';
    document.getElementById('passwordArea').style.display = (status === 'Approved') ? 'block' : 'none';
  }

  async function saveStudioStatus() {
    const status = document.getElementById('studioStatusSelect').value;
    const link = document.getElementById('studioContentLink').value;
    const password = document.getElementById('headPassword').value;

    const data = { studio_status: status };

    if(status === 'Submitted for Review') {
      if(!link) return alert('Content Link is required for review.');
      data.content_link = link;
    }

    if(status === 'Approved') {
      if(password !== '207') return alert('Invalid Head Password');
      data.password = password; // API will verify again
      data.approved_by = 'Head of Content';
    }

    try {
      await updateStudioStatus(selectedStudioId, data);
      closeModal('studioModal');
      loadStudioCalendar();
      alert('Status Updated');
    } catch(e) {
      alert(e.message);
    }
  }

  // --- HOT PRODUCTS ---
  document.getElementById('addHotForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      await addHotProduct({
        category: document.getElementById('hotCategory').value,
        productLink: document.getElementById('hotLink').value,
        salesCount: document.getElementById('hotSales').value
      });
      loadHotProducts();
      document.getElementById('addHotForm').reset();
    } catch(e) { alert(e.message); }
  });

  async function loadHotProducts() {
    const data = await getAllHotProducts();
    document.querySelector('#hotTable tbody').innerHTML = data.map(p => `
      <tr>
        <td>${p.category}</td>
        <td><a href="${p.product_link}" target="_blank">Link</a></td>
        <td>${p.sales_count}</td>
        <td>${p.listed ? '‚úÖ' : '‚ùå'}</td>
        <td><button class="btn btn-danger btn-sm" onclick="deleteHotProductItem(${p.id})">Delete</button></td>
      </tr>
    `).join('');
  }

  async function deleteHotProductItem(id) {
    if(confirm('Delete?')) {
      await deleteHotProduct(id);
      loadHotProducts();
    }
  }

  // --- CONTENT CALENDAR ---
  async function loadContent() {
    const data = await getAllContentBookings();
    document.querySelector('#contentTable tbody').innerHTML = data.map(c => `
      <tr>
        <td>${c.date}</td>
        <td>${c.theme}</td>
        <td>${c.category}</td>
        <td>${c.productCode || '-'}</td>
        <td>${c.status}</td>
        <td>-</td>
      </tr>
    `).join('');
  }

  // --- UTILS ---
  function closeModal(id) {
    document.getElementById(id).style.display = 'none';
  }
  
  function rejectProduct(id) {
     const reason = prompt("Reason for rejection:");
     if(reason) updateProductReview(id, {status:'Rejected', rejectionReason: reason}).then(loadProducts);
  }

</script>
</body>
</html>
