<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Hub - Digital Marketing Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #FFFFFF;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1d1d1f;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Password Screen */
        .password-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #422B73 0%, #5a3d94 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .password-screen.hidden {
            display: none;
        }

        .password-box {
            background: white;
            padding: 48px 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(66, 43, 115, 0.3);
            text-align: center;
            max-width: 420px;
            width: 90%;
        }

        .password-box h2 {
            color: #1d1d1f;
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .password-box p {
            color: #6B6B6B;
            margin-bottom: 32px;
            font-size: 15px;
            font-weight: 400;
        }

        .password-input {
            width: 100%;
            padding: 16px 20px;
            border: 1.5px solid #d2d2d7;
            border-radius: 12px;
            font-size: 17px;
            margin-bottom: 20px;
            outline: none;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .password-input:focus {
            border-color: #422B73;
            box-shadow: 0 0 0 4px rgba(66, 43, 115, 0.1);
        }

        .password-btn {
            width: 100%;
            padding: 16px 20px;
            background: #422B73;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .password-btn:hover {
            background: #5a3d94;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 43, 115, 0.3);
        }

        .password-btn:active {
            transform: translateY(0);
        }

        .password-error {
            color: #ff3b30;
            font-size: 14px;
            margin-top: 12px;
            display: none;
            font-weight: 500;
        }

        .password-error.show {
            display: block;
        }

        /* Main App */
        .main-app {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        .main-app.visible {
            display: flex;
        }

        .header {
            background: #422B73;
            color: white;
            padding: 16px 32px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background: #f5f5f7;
        }

        .sidebar {
            width: 380px;
            background: white;
            border-right: 1px solid #d2d2d7;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 24px 20px 20px 20px;
            border-bottom: 1px solid #d2d2d7;
            background: #fbfbfb;
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1d1d1f;
            letter-spacing: -0.3px;
        }

        .platform-filters {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .platform-filter {
            padding: 12px 14px;
            background: white;
            border: 1.5px solid #d2d2d7;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: #1d1d1f;
        }

        .platform-filter:hover {
            border-color: #422B73;
            background: #faf9fb;
        }

        .platform-filter.active {
            background: #422B73;
            color: white;
            border-color: #422B73;
        }

        .platform-filter .count {
            margin-left: auto;
            background: rgba(0,0,0,0.08);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .platform-filter.active .count {
            background: rgba(255,255,255,0.2);
        }

        .unreplied-badge {
            background: #ff3b30;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 6px;
        }

        .page-filters {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .page-filter {
            padding: 10px 14px;
            background: white;
            border: 1.5px solid #e8e8ed;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #1d1d1f;
        }

        .page-filter:hover {
            border-color: #422B73;
            background: #faf9fb;
        }

        .page-filter.active {
            background: #422B73;
            color: white;
            border-color: #422B73;
        }

        .page-filter .count {
            margin-left: auto;
            background: rgba(0,0,0,0.06);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .page-filter.active .count {
            background: rgba(255,255,255,0.2);
        }

        .conversation-list {
            list-style: none;
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f5f5f7;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: white;
        }

        .conversation-item:hover {
            background: #fafafa;
        }

        .conversation-item.active {
            background: #f5f4f7;
            border-left: 3px solid #422B73;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .conversation-page {
            font-size: 11px;
            color: #422B73;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .conversation-time {
            font-size: 11px;
            color: #86868b;
            font-weight: 500;
        }

        .conversation-name-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .conversation-name {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.2px;
        }

        .unreplied-badge-small {
            background: #ff3b30;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
        }

        .conversation-id {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 6px;
            font-weight: 400;
        }

        .conversation-footer {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }

        .window-status {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .window-status.window-green {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .window-status.window-orange {
            background: #fff3e0;
            color: #f57c00;
        }

        .window-status.window-red {
            background: #ffebee;
            color: #c62828;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #FFFFFF;
        }

        .chat-header {
            padding: 20px 32px;
            border-bottom: 1px solid #d2d2d7;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #1d1d1f;
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header-info p {
            font-size: 13px;
            color: #6B6B6B;
            font-weight: 400;
        }

        .chat-header-info .page-badge {
            display: inline-block;
            background: #f5f4f7;
            color: #422B73;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            border: 1px solid #e8e8ed;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: #f5f5f7;
            border: 1px solid #d2d2d7;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            color: #1d1d1f;
            font-family: inherit;
        }

        .action-btn:hover {
            background: #e8e8ed;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            background: #FFFFFF;
        }

        .message-date-divider {
            text-align: center;
            margin: 24px 0;
            font-size: 12px;
            color: #86868b;
            position: relative;
            font-weight: 600;
        }

        .message-date-divider::before,
        .message-date-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e8e8ed;
        }

        .message-date-divider::before {
            left: 0;
        }

        .message-date-divider::after {
            right: 0;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.customer {
            align-items: flex-start;
        }

        .message.agent {
            align-items: flex-end;
        }

        .message-bubble {
            max-width: 65%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            font-size: 15px;
            line-height: 1.5;
        }

        .message.customer .message-bubble {
            background: #f5f5f7;
            color: #1d1d1f;
            border-bottom-left-radius: 4px;
        }

        .message.agent .message-bubble {
            background: #422B73;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            cursor: pointer;
            transition: opacity 0.2s ease;
            display: block;
        }

        .message-image:hover {
            opacity: 0.9;
        }

        .message-time {
            font-size: 11px;
            color: #86868b;
            margin-top: 4px;
            padding: 0 5px;
            font-weight: 500;
        }

        .reply-area {
            padding: 20px 32px;
            border-top: 1px solid #d2d2d7;
            background: white;
        }

        .window-warning {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #e65100;
            font-weight: 500;
        }

        .warning-icon {
            font-size: 16px;
        }

        .image-preview {
            display: none;
            position: relative;
            margin-bottom: 12px;
            padding: 12px;
            background: #f5f5f7;
            border-radius: 10px;
            border: 1px solid #d2d2d7;
        }

        .preview-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #d2d2d7;
        }

        .preview-info {
            flex: 1;
        }

        .preview-info p {
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .preview-info span {
            font-size: 12px;
            color: #6B6B6B;
        }

        .cancel-preview-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .cancel-preview-btn:hover {
            background: #d32f2f;
        }

        .reply-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .reply-input {
            flex: 1;
            padding: 14px 20px;
            border: 1.5px solid #d2d2d7;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
            font-family: inherit;
            background: white;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .reply-input:focus {
            border-color: #422B73;
            box-shadow: 0 0 0 4px rgba(66, 43, 115, 0.08);
        }

        .reply-input:disabled {
            background: #f5f5f7;
            color: #86868b;
            cursor: not-allowed;
        }

        .image-upload-btn {
            background: #f5f5f7;
            border: 1.5px solid #d2d2d7;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .image-upload-btn:hover {
            background: #e8e8ed;
            border-color: #422B73;
        }

        .image-upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn {
            background: #422B73;
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
            font-family: inherit;
            height: 44px;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #5a3d94;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 43, 115, 0.3);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 15px;
            color: #6B6B6B;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #86868b;
        }

        .loading-spinner {
            border: 3px solid #f5f5f7;
            border-top: 3px solid #422B73;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: #1d1d1f;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.error {
            background: #ff3b30;
        }

        .toast.success {
            background: #34c759;
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
        }

        .close-modal {
            position: absolute;
            top: 24px;
            right: 32px;
            color: white;
            font-size: 40px;
            font-weight: 300;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .close-modal:hover {
            opacity: 0.7;
        }

        #imageInput {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d2d2d7;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #86868b;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 380px;
            }
            .container {
                flex-direction: column;
            }
            .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="password-screen" id="passwordScreen">
        <div class="password-box">
            <h2>üîí Messenger Hub</h2>
            <p>Enter password to access</p>
            <input type="password" 
                   class="password-input" 
                   id="passwordInput" 
                   placeholder="Enter password"
                   onkeypress="if(event.key==='Enter') checkPassword()">
            <button class="password-btn" onclick="checkPassword()">Unlock</button>
            <div class="password-error" id="passwordError">Incorrect password. Try again.</div>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="header">
            <h1>üí¨ Messenger Hub</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="location.reload()">üîÑ Refresh</button>
                <button class="header-btn" onclick="logout()">üîì Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>Conversations</h2>
                    <div class="platform-filters" id="platformFilters">
                        <div class="platform-filter active" onclick="filterByPlatform('all')">
                            üåê All Platforms
                            <span class="count">0</span>
                        </div>
                    </div>
                    <div class="page-filters" id="pageFilters">
                        <div class="page-filter active" onclick="filterByPage('all')">
                            üìò All Pages
                            <span class="count">0</span>
                        </div>
                    </div>
                </div>
                <ul class="conversation-list" id="conversationList">
                    <li class="loading">
                        <div class="loading-spinner"></div>
                        Loading conversations...
                    </li>
                </ul>
            </div>

            <div class="chat-area">
                <div class="chat-header" id="chatHeader" style="display: none;">
                    <div class="chat-header-info">
                        <h3 id="chatTitle">Select a conversation</h3>
                        <p id="chatSubtitle"></p>
                        <span class="page-badge" id="pageBadge"></span>
                    </div>
                    <div class="chat-actions">
                        <button class="action-btn" onclick="refreshCurrentChat()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <h3>No conversation selected</h3>
                        <p>Select a conversation from the list to start messaging</p>
                    </div>
                </div>
                
                <div class="reply-area">
                    <div class="window-warning" id="windowWarning">
                        <span class="warning-icon">‚ö†Ô∏è</span>
                        <span>This conversation is outside the 24-hour window</span>
                    </div>

                    <div class="image-preview" id="imagePreview">
                        <div class="preview-container">
                            <img src="" alt="Preview" class="preview-image" id="previewImage">
                            <div class="preview-info">
                                <p>Image ready to send</p>
                                <span>Click send or cancel</span>
                            </div>
                            <button class="cancel-preview-btn" onclick="cancelImageUpload()">Cancel</button>
                        </div>
                    </div>

                    <div class="reply-input-wrapper">
                        <input type="file" id="imageInput" accept="image/*">
                        <button class="image-upload-btn" id="imageUploadBtn" onclick="triggerImageUpload()" disabled title="Upload image">üì∑</button>
                        <textarea class="reply-input" id="replyInput" placeholder="Type your message..." disabled rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendReply()" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="close-modal">&times;</span>
        <img src="" alt="Full size image" class="modal-content" id="modalImage">
    </div>

    <script>
        // ============================================
        // API CONFIGURATION
        // ============================================
        const API_BASE_URL = 'https://chathubfactory.onrender.com';

        // ============================================
        // API HANDLERS
        // ============================================
        const messengerSupabase = {
            API_BASE_URL: API_BASE_URL,

            async getConversations() {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/api/conversations`, {
                        method: 'GET',
                        headers: {'Content-Type': 'application/json'}
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return {success: data.success || false, data: data.conversations || [], error: data.error || null};
                } catch (error) {
                    console.error('Error fetching conversations:', error);
                    return {success: false, data: [], error: error.message};
                }
            },

            async getMessages(conversationId) {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/api/conversation/${conversationId}`, {
                        method: 'GET',
                        headers: {'Content-Type': 'application/json'}
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return {success: data.success || false, data: data.messages || [], error: data.error || null};
                } catch (error) {
                    console.error('Error fetching messages:', error);
                    return {success: false, data: [], error: error.message};
                }
            },

            async getUnrepliedCounts() {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/api/unreplied-counts`, {
                        method: 'GET',
                        headers: {'Content-Type': 'application/json'}
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return {success: data.success || false, counts: data.counts || {}, error: data.error || null};
                } catch (error) {
                    console.error('Error fetching unreplied counts:', error);
                    return {success: false, counts: {}, error: error.message};
                }
            },

            checkConversationWindow(lastMessageTime) {
                const now = new Date();
                const lastMessage = new Date(lastMessageTime);
                const hoursPassed = (now - lastMessage) / (1000 * 60 * 60);
                const daysPassed = hoursPassed / 24;

                if (hoursPassed <= 24) {
                    return {status: 'open', color: 'green', canReply: true, message: 'You can reply freely', hoursRemaining: Math.floor(24 - hoursPassed), requiresTag: false};
                } else if (daysPassed <= 7) {
                    return {status: 'extended', color: 'orange', canReply: true, message: 'Extended customer service window', daysRemaining: Math.floor(7 - daysPassed), requiresTag: true};
                } else {
                    return {status: 'closed', color: 'red', canReply: false, message: 'Conversation window expired', daysExpired: Math.floor(daysPassed - 7), requiresTag: false};
                }
            }
        };

        const renderAPI = {
            API_BASE_URL: API_BASE_URL,

            async sendMessage(pageId, recipientId, messageText, useHumanAgentTag = false) {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/api/send`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({page_id: pageId, recipient_id: recipientId, message_text: messageText, use_human_agent_tag: useHumanAgentTag})
                    });
                    const data = await response.json();
                    if (!response.ok) return {success: false, error: data.error || `HTTP ${response.status}`, data: null};
                    return {success: data.success || true, data: data.data || null, error: null};
                } catch (error) {
                    console.error('Error sending message:', error);
                    return {success: false, error: error.message, data: null};
                }
            },

            async sendImageMessage(pageId, recipientId, imageFile, useHumanAgentTag = false) {
                try {
                    const formData = new FormData();
                    formData.append('page_id', pageId);
                    formData.append('recipient_id', recipientId);
                    formData.append('image', imageFile);
                    formData.append('use_human_agent_tag', useHumanAgentTag);
                    const response = await fetch(`${this.API_BASE_URL}/api/send-image`, {method: 'POST', body: formData});
                    const data = await response.json();
                    if (!response.ok) return {success: false, error: data.error || `HTTP ${response.status}`, data: null};
                    return {success: data.success || true, data: data.data || null, error: null};
                } catch (error) {
                    console.error('Error sending image:', error);
                    return {success: false, error: error.message, data: null};
                }
            }
        };

        // ============================================
        // APP STATE
        // ============================================
        const MESSENGER_PASSWORD = 'kapruka2026';
        let conversations = [];
        let currentConversation = null;
        let currentMessages = [];
        let currentPageFilter = 'all';
        let currentPlatformFilter = 'all';
        let autoRefreshInterval = null;
        let pageStats = {};
        let platformStats = {};
        let unrepliedCounts = {};
        let selectedImageFile = null;

        document.addEventListener('DOMContentLoaded', () => checkAuth());

        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('messengerAuth');
            if (isAuthenticated === 'true') showMainApp();
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const password = input.value;
            if (password === MESSENGER_PASSWORD) {
                sessionStorage.setItem('messengerAuth', 'true');
                showMainApp();
            } else {
                document.getElementById('passwordError').classList.add('show');
                input.value = '';
                input.focus();
                setTimeout(() => document.getElementById('passwordError').classList.remove('show'), 3000);
            }
        }

        function logout() {
            sessionStorage.removeItem('messengerAuth');
            location.reload();
        }

        function showMainApp() {
            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('visible');
            loadConversations();
            setupEventListeners();
            startAutoRefresh();
        }

        function setupEventListeners() {
            const replyInput = document.getElementById('replyInput');
            replyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendReply();
                }
            });
            
            // Auto-expand textarea
            replyInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            const imageInput = document.getElementById('imageInput');
            if (imageInput) imageInput.addEventListener('change', handleImageSelect);
        }

        async function loadConversations() {
            try {
                const result = await messengerSupabase.getConversations();
                if (result.error) {
                    showToast('Error loading conversations: ' + result.error, 'error');
                    return;
                }
                conversations = result.data || [];
                await loadUnrepliedCounts();
                calculatePageStats();
                calculatePlatformStats();
                renderPlatformFilters();
                renderPageFilters();
                renderConversations();
            } catch (error) {
                showToast('Failed to load conversations', 'error');
                console.error(error);
            }
        }

        async function loadUnrepliedCounts() {
            try {
                const result = await messengerSupabase.getUnrepliedCounts();
                if (result.success) unrepliedCounts = result.counts || {};
            } catch (error) {
                console.error('Error loading unreplied counts:', error);
            }
        }

        function calculatePageStats() {
            pageStats = {};
            conversations.forEach(conv => {
                const pageKey = conv.page_id || 'unknown';
                if (!pageStats[pageKey]) {
                    pageStats[pageKey] = {name: conv.page_name || 'Unknown Page', count: 0, unrepliedConversations: 0};
                }
                pageStats[pageKey].count++;
                const unrepliedKey = `${conv.page_id}_${conv.customer_psid}`;
                if (unrepliedCounts[unrepliedKey] && unrepliedCounts[unrepliedKey] > 0) {
                    pageStats[pageKey].unrepliedConversations++;
                }
            });
        }

        function calculatePlatformStats() {
            platformStats = {};
            conversations.forEach(conv => {
                const platform = conv.platform || 'facebook';
                if (!platformStats[platform]) {
                    platformStats[platform] = {name: getPlatformName(platform), icon: getPlatformIcon(platform), count: 0, unrepliedConversations: 0};
                }
                platformStats[platform].count++;
                const unrepliedKey = `${conv.page_id}_${conv.customer_psid}`;
                if (unrepliedCounts[unrepliedKey] && unrepliedCounts[unrepliedKey] > 0) {
                    platformStats[platform].unrepliedConversations++;
                }
            });
        }

        function getPlatformName(platform) {
            const names = {'facebook': 'Facebook', 'instagram': 'Instagram', 'whatsapp': 'WhatsApp', 'messenger': 'Messenger'};
            return names[platform] || platform.charAt(0).toUpperCase() + platform.slice(1);
        }

        function getPlatformIcon(platform) {
            const icons = {'facebook': 'üìò', 'instagram': 'üì∑', 'whatsapp': 'üí¨', 'messenger': 'üí¨'};
            return icons[platform] || 'üí¨';
        }

        function renderPlatformFilters() {
            const container = document.getElementById('platformFilters');
            if (!container) return;
            const totalCount = conversations.length;
            
            // Count unreplied CONVERSATIONS not messages
            let totalUnrepliedConvs = 0;
            const counted = new Set();
            Object.keys(unrepliedCounts).forEach(key => {
                if (unrepliedCounts[key] > 0 && !counted.has(key)) {
                    totalUnrepliedConvs++;
                    counted.add(key);
                }
            });
            
            let html = `<div class="platform-filter ${currentPlatformFilter === 'all' ? 'active' : ''}" onclick="filterByPlatform('all')">üåê All Platforms<span class="count">${totalCount}</span>${totalUnrepliedConvs > 0 ? `<span class="unreplied-badge">${totalUnrepliedConvs}</span>` : ''}</div>`;
            Object.keys(platformStats).forEach(platform => {
                const stat = platformStats[platform];
                html += `<div class="platform-filter ${currentPlatformFilter === platform ? 'active' : ''}" onclick="filterByPlatform('${platform}')">${stat.icon} ${stat.name}<span class="count">${stat.count}</span>${stat.unrepliedConversations > 0 ? `<span class="unreplied-badge">${stat.unrepliedConversations}</span>` : ''}</div>`;
            });
            container.innerHTML = html;
        }

        function filterByPlatform(platform) {
            currentPlatformFilter = platform;
            currentPageFilter = 'all';
            renderPlatformFilters();
            renderPageFilters();
            renderConversations();
        }

        function renderPageFilters() {
            const container = document.getElementById('pageFilters');
            let platformFilteredConvs = conversations;
            if (currentPlatformFilter !== 'all') {
                platformFilteredConvs = conversations.filter(c => (c.platform || 'facebook') === currentPlatformFilter);
            }
            const totalCount = platformFilteredConvs.length;
            let filteredPageStats = {};
            platformFilteredConvs.forEach(conv => {
                const pageKey = conv.page_id || 'unknown';
                if (!filteredPageStats[pageKey]) {
                    filteredPageStats[pageKey] = {name: conv.page_name || 'Unknown Page', count: 0, unrepliedConversations: 0};
                }
                filteredPageStats[pageKey].count++;
                const unrepliedKey = `${conv.page_id}_${conv.customer_psid}`;
                if (unrepliedCounts[unrepliedKey] && unrepliedCounts[unrepliedKey] > 0) {
                    filteredPageStats[pageKey].unrepliedConversations++;
                }
            });
            let html = `<div class="page-filter ${currentPageFilter === 'all' ? 'active' : ''}" onclick="filterByPage('all')">üìò All Pages<span class="count">${totalCount}</span></div>`;
            Object.keys(filteredPageStats).forEach(pageId => {
                const page = filteredPageStats[pageId];
                html += `<div class="page-filter ${currentPageFilter === pageId ? 'active' : ''}" onclick="filterByPage('${pageId}')">üìÑ ${page.name}<span class="count">${page.count}</span>${page.unrepliedConversations > 0 ? `<span class="unreplied-badge">${page.unrepliedConversations}</span>` : ''}</div>`;
            });
            container.innerHTML = html;
        }

        function filterByPage(pageId) {
            currentPageFilter = pageId;
            renderPageFilters();
            renderConversations();
        }

        function renderConversations() {
            const list = document.getElementById('conversationList');
            let filteredConversations = conversations;
            if (currentPlatformFilter !== 'all') {
                filteredConversations = filteredConversations.filter(c => (c.platform || 'facebook') === currentPlatformFilter);
            }
            if (currentPageFilter !== 'all') {
                filteredConversations = filteredConversations.filter(c => c.page_id === currentPageFilter);
            }
            if (filteredConversations.length === 0) {
                list.innerHTML = `<li class="loading"><div class="empty-state"><p>No conversations for this filter</p></div></li>`;
                return;
            }
            list.innerHTML = filteredConversations.map(conv => {
                const windowStatus = messengerSupabase.checkConversationWindow(conv.last_message_time);
                const unrepliedKey = `${conv.page_id}_${conv.customer_psid}`;
                const unrepliedCount = unrepliedCounts[unrepliedKey] || 0;
                const platform = conv.platform || 'facebook';
                const platformIcon = getPlatformIcon(platform);
                
                // ‚úÖ UPDATED: Better display name logic
                let displayName;
                if (conv.customer_name && conv.customer_name !== 'Unknown' && !conv.customer_name.startsWith('User #') && !conv.customer_name.startsWith('Customer ')) {
                    displayName = conv.customer_name;
                } else {
                    displayName = `Customer ${conv.customer_psid.substring(0, 8)}...`;
                }
                
                return `<li class="conversation-item ${currentConversation && currentConversation.id === conv.conversation_id ? 'active' : ''}" data-conversation-id="${conv.conversation_id}" data-page-name="${escapeQuotes(conv.page_name || 'Facebook Page')}" data-page-id="${conv.page_id}" data-customer-psid="${conv.customer_psid}" data-customer-name="${escapeQuotes(displayName)}" data-platform="${platform}" data-last-message-time="${conv.last_message_time}"><div class="conversation-header"><div class="conversation-page">${platformIcon} ${conv.page_name || 'Facebook Page'}</div><div class="conversation-time">${formatTime(conv.last_message_time)}</div></div><div class="conversation-name-row"><div class="conversation-name">${displayName}</div>${unrepliedCount > 0 ? `<span class="unreplied-badge-small">${unrepliedCount}</span>` : ''}</div><div class="conversation-id">ID: ${conv.customer_psid.substring(0, 20)}...</div><div class="conversation-footer"><span class="window-status window-${windowStatus.color}">${windowStatus.status === 'open' ? 'üü¢' : windowStatus.status === 'extended' ? 'üü†' : 'üî¥'} ${windowStatus.message.split('(')[0].trim()}</span></div></li>`;
            }).join('');
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectConversation(this.getAttribute('data-conversation-id'), this.getAttribute('data-page-name'), this.getAttribute('data-page-id'), this.getAttribute('data-customer-psid'), this.getAttribute('data-customer-name'), this.getAttribute('data-platform'), this.getAttribute('data-last-message-time'));
                });
            });
        }

        async function selectConversation(conversationId, pageName, pageId, customerPsid, customerName, platform, lastMessageTime) {
            currentConversation = {id: conversationId, pageName: pageName, pageId: pageId, customerPsid: customerPsid, customerName: customerName, platform: platform || 'facebook', lastMessageTime: lastMessageTime};
            await loadMessages();
            updateChatHeader();
            updateReplyAreaBasedOnWindow();
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
            const selectedItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
            if (selectedItem) selectedItem.classList.add('active');
        }

        function updateReplyAreaBasedOnWindow() {
            if (!currentConversation) return;
            const windowStatus = messengerSupabase.checkConversationWindow(currentConversation.lastMessageTime);
            const replyInput = document.getElementById('replyInput');
            const sendBtn = document.getElementById('sendBtn');
            const imageBtn = document.getElementById('imageUploadBtn');
            const windowWarning = document.getElementById('windowWarning');
            if (windowStatus.canReply) {
                replyInput.disabled = false;
                sendBtn.disabled = false;
                if (imageBtn) imageBtn.disabled = false;
                if (windowStatus.status === 'extended' && windowWarning) {
                    windowWarning.style.display = 'flex';
                    windowWarning.innerHTML = `<span class="warning-icon">‚ö†Ô∏è</span><span>${windowStatus.message}</span>`;
                } else if (windowWarning) {
                    windowWarning.style.display = 'none';
                }
            } else {
                replyInput.disabled = true;
                sendBtn.disabled = true;
                if (imageBtn) imageBtn.disabled = true;
                replyInput.placeholder = 'Conversation window expired...';
                if (windowWarning) {
                    windowWarning.style.display = 'flex';
                    windowWarning.innerHTML = `<span class="warning-icon">üî¥</span><span>This conversation expired ${windowStatus.daysExpired} days ago. You cannot send messages.</span>`;
                }
            }
        }

        async function loadMessages() {
            if (!currentConversation) return;
            try {
                const result = await messengerSupabase.getMessages(currentConversation.id);
                if (result.error) {
                    showToast('Error loading messages: ' + result.error, 'error');
                    return;
                }
                currentMessages = result.data || [];
                renderMessages();
            } catch (error) {
                showToast('Failed to load messages', 'error');
                console.error(error);
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            if (currentMessages.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>No messages yet</h3><p>Start the conversation by sending a message</p></div>`;
                return;
            }
            let html = '';
            let lastDate = '';
            currentMessages.forEach(msg => {
                const msgDate = new Date(msg.created_at).toLocaleDateString();
                if (msgDate !== lastDate) {
                    html += `<div class="message-date-divider">${formatDate(msg.created_at)}</div>`;
                    lastDate = msgDate;
                }
                const messageType = msg.message_type || 'text';
                const isImage = messageType === 'image' || msg.image_url;
                html += `<div class="message ${msg.sender_type}"><div class="message-bubble">${isImage ? `<img src="${msg.image_url}" alt="Sent image" class="message-image" onclick="openImageModal('${msg.image_url}')">` : escapeHtml(msg.message_text)}</div><div class="message-time">${formatMessageTime(msg.created_at)}</div></div>`;
            });
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function openImageModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            if (modal && modalImg) {
                modal.style.display = 'flex';
                modalImg.src = imageUrl;
            }
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) modal.style.display = 'none';
        }

        function updateChatHeader() {
            const header = document.getElementById('chatHeader');
            const title = document.getElementById('chatTitle');
            const subtitle = document.getElementById('chatSubtitle');
            const badge = document.getElementById('pageBadge');
            if (currentConversation) {
                header.style.display = 'flex';
                const windowStatus = messengerSupabase.checkConversationWindow(currentConversation.lastMessageTime);
                const statusIcon = windowStatus.status === 'open' ? 'üü¢' : windowStatus.status === 'extended' ? 'üü†' : 'üî¥';
                title.innerHTML = `${statusIcon} ${currentConversation.customerName}`;
                subtitle.textContent = `Customer ID: ${currentConversation.customerPsid}`;
                badge.textContent = `${getPlatformIcon(currentConversation.platform)} ${currentConversation.pageName}`;
            }
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size must be less than 5MB', 'error');
                return;
            }
            selectedImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                showImagePreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function showImagePreview(imageSrc) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImage');
            if (preview && previewImg) {
                previewImg.src = imageSrc;
                preview.style.display = 'flex';
            }
        }

        function cancelImageUpload() {
            selectedImageFile = null;
            const preview = document.getElementById('imagePreview');
            const imageInput = document.getElementById('imageInput');
            if (preview) preview.style.display = 'none';
            if (imageInput) imageInput.value = '';
        }

        function triggerImageUpload() {
            const imageInput = document.getElementById('imageInput');
            if (imageInput) imageInput.click();
        }

        async function sendReply() {
            const input = document.getElementById('replyInput');
            const messageText = input.value.trim();
            if (!messageText && !selectedImageFile) return;
            if (!currentConversation) return;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            try {
                const windowStatus = messengerSupabase.checkConversationWindow(currentConversation.lastMessageTime);
                const useHumanAgentTag = windowStatus.requiresTag;
                
                console.log('Sending message with:');
                console.log('  Page ID:', currentConversation.pageId);
                console.log('  Customer PSID:', currentConversation.customerPsid);
                console.log('  Message:', messageText);
                console.log('  Use Human Agent Tag:', useHumanAgentTag);
                
                let result;
                if (selectedImageFile) {
                    result = await renderAPI.sendImageMessage(currentConversation.pageId, currentConversation.customerPsid, selectedImageFile, useHumanAgentTag);
                    if (result.success) cancelImageUpload();
                }
                if (messageText && (!selectedImageFile || result.success)) {
                    result = await renderAPI.sendMessage(currentConversation.pageId, currentConversation.customerPsid, messageText, useHumanAgentTag);
                    if (result.success) {
                        input.value = '';
                        input.style.height = 'auto';
                    }
                }
                if (result.success) {
                    showToast('Message sent successfully', 'success');
                    setTimeout(() => loadMessages(), 500);
                } else {
                    showToast('Failed to send message: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showToast('Error sending message', 'error');
                console.error(error);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        async function refreshCurrentChat() {
            if (currentConversation) {
                await loadMessages();
                showToast('Messages refreshed', 'success');
            }
        }

        function startAutoRefresh() {
            // Auto-refresh every 30 seconds
            autoRefreshInterval = setInterval(() => {
                console.log('üîÑ Auto-refreshing conversations and messages...');
                loadConversations();
                if (currentConversation) loadMessages();
            }, 30000);  // 30000ms = 30 seconds
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
            return date.toLocaleDateString();
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeQuotes(text) {
            return text.replace(/'/g, "\\\\'").replace(/"/g, '&quot;');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
